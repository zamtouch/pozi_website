#!/usr/bin/env node

/**
 * Setup Collexia Payment Collection Fields in Directus
 * 
 * This script creates the required fields for Collexia integration:
 * - In 'directus_users' collection: account_number, bank_id, account_type, id_number, id_type
 * - In 'applications' collection: collexia_contract_reference
 */

require('dotenv').config({ path: '.env.local' });

const DIRECTUS_BASE_URL = process.env.NEXT_PUBLIC_DIRECTUS_URL || process.env.DIRECTUS_URL || 'https://app.pozi.com.na';
const API_TOKEN = process.env.DIRECTUS_ADMIN_TOKEN || process.env.DIRECTUS_TOKEN || '';

async function setupCollexiaFields() {
  if (!API_TOKEN) {
    console.error('âŒ Error: DIRECTUS_ADMIN_TOKEN or DIRECTUS_TOKEN not found in .env.local');
    console.error('   Please add your Directus admin token to .env.local\n');
    process.exit(1);
  }

  console.log('ðŸ” Setting up Collexia payment collection fields...\n');
  console.log(`ðŸ“¡ Directus URL: ${DIRECTUS_BASE_URL}\n`);

  // Fields to add to directus_users collection
  const userFields = [
    {
      field: 'account_number',
      type: 'string',
      meta: {
        interface: 'input',
        width: 'half',
        required: false,
        note: 'Student bank account number (required for Collexia payment collection)',
        options: {
          placeholder: 'e.g., 62001543455',
        },
      },
      schema: {
        max_length: 50,
        is_nullable: true,
      },
    },
    {
      field: 'bank_id',
      type: 'integer',
      meta: {
        interface: 'select-dropdown',
        width: 'half',
        required: false,
        note: 'Bank ID code (required for Collexia). 64=Bank Windhoek, 65=FNB, 71=Nedbank, etc.',
        options: {
          choices: [
            { text: 'Bank Windhoek', value: 64 },
            { text: 'FNB Namibia', value: 65 },
            { text: 'TrustCo Bank', value: 66 },
            { text: 'Bank AtlÃ¡ntico', value: 67 },
            { text: 'BankBIC', value: 68 },
            { text: 'Bank of Namibia', value: 69 },
            { text: 'Letshego Bank Namibia', value: 70 },
            { text: 'Nedbank Namibia', value: 71 },
            { text: 'Standard Bank Namibia', value: 72 },
          ],
        },
      },
      schema: {
        is_nullable: true,
      },
    },
    {
      field: 'account_type',
      type: 'integer',
      meta: {
        interface: 'select-dropdown',
        width: 'half',
        required: false,
        note: 'Account type: 1=Current, 2=Savings, 3=Transmission',
        options: {
          choices: [
            { text: 'Current (Cheque)', value: 1 },
            { text: 'Savings', value: 2 },
            { text: 'Transmission', value: 3 },
          ],
        },
      },
      schema: {
        default_value: 1,
        is_nullable: true,
      },
    },
    {
      field: 'id_number',
      type: 'string',
      meta: {
        interface: 'input',
        width: 'half',
        required: false,
        note: 'Student ID number (for Collexia mandate)',
        options: {
          placeholder: 'e.g., 1234567890123',
        },
      },
      schema: {
        max_length: 50,
        is_nullable: true,
      },
    },
    {
      field: 'id_type',
      type: 'integer',
      meta: {
        interface: 'select-dropdown',
        width: 'half',
        required: false,
        note: 'ID type: 1=RSA ID, 2=Passport, 3=Temp ID, 4=Business',
        options: {
          choices: [
            { text: 'RSA ID', value: 1 },
            { text: 'Passport', value: 2 },
            { text: 'Temp ID', value: 3 },
            { text: 'Business', value: 4 },
          ],
        },
      },
      schema: {
        default_value: 1,
        is_nullable: true,
      },
    },
  ];

  // Fields to add to applications collection for Collexia tracking
  const applicationFields = [
    {
      field: 'collexia_contract_reference',
      type: 'string',
      meta: {
        interface: 'input',
        width: 'full',
        required: false,
        readonly: true,
        note: 'Collexia mandate contract reference (auto-populated when mandate is registered)',
        options: {
          placeholder: 'Auto-generated by Collexia',
        },
      },
      schema: {
        max_length: 50,
        is_nullable: true,
      },
    },
    {
      field: 'collexia_student_id',
      type: 'string',
      meta: {
        interface: 'input',
        width: 'half',
        required: false,
        readonly: true,
        note: 'Collexia student ID (POZI-{user_id})',
      },
      schema: {
        max_length: 100,
        is_nullable: true,
      },
    },
    {
      field: 'collexia_property_code',
      type: 'string',
      meta: {
        interface: 'input',
        width: 'half',
        required: false,
        readonly: true,
        note: 'Collexia property code (PROP-{property_id})',
      },
      schema: {
        max_length: 100,
        is_nullable: true,
      },
    },
    {
      field: 'collexia_student_registered',
      type: 'boolean',
      meta: {
        interface: 'boolean',
        width: 'half',
        required: false,
        readonly: true,
        note: 'Whether student was successfully registered in Collexia',
      },
      schema: {
        default_value: false,
        is_nullable: true,
      },
    },
    {
      field: 'collexia_property_registered',
      type: 'boolean',
      meta: {
        interface: 'boolean',
        width: 'half',
        required: false,
        readonly: true,
        note: 'Whether property was successfully registered in Collexia',
      },
      schema: {
        default_value: false,
        is_nullable: true,
      },
    },
    {
      field: 'collexia_mandate_registered',
      type: 'boolean',
      meta: {
        interface: 'boolean',
        width: 'half',
        required: false,
        readonly: true,
        note: 'Whether mandate was successfully registered in Collexia',
      },
      schema: {
        default_value: false,
        is_nullable: true,
      },
    },
    {
      field: 'collexia_integration_date',
      type: 'timestamp',
      meta: {
        interface: 'datetime',
        width: 'half',
        required: false,
        readonly: true,
        note: 'Date/time when Collexia integration was attempted',
      },
      schema: {
        is_nullable: true,
      },
    },
    {
      field: 'collexia_integration_status',
      type: 'string',
      meta: {
        interface: 'select-dropdown',
        width: 'half',
        required: false,
        readonly: true,
        note: 'Overall Collexia integration status',
        options: {
          choices: [
            { text: 'Not Started', value: 'not_started' },
            { text: 'In Progress', value: 'in_progress' },
            { text: 'Completed', value: 'completed' },
            { text: 'Failed', value: 'failed' },
          ],
        },
      },
      schema: {
        max_length: 50,
        default_value: 'not_started',
        is_nullable: true,
      },
    },
    {
      field: 'collexia_error_message',
      type: 'text',
      meta: {
        interface: 'input-multiline',
        width: 'full',
        required: false,
        readonly: true,
        note: 'Error message if Collexia integration failed',
      },
      schema: {
        is_nullable: true,
      },
    },
    {
      field: 'collexia_student_data',
      type: 'text',
      meta: {
        interface: 'input-code',
        width: 'full',
        required: false,
        readonly: true,
        note: 'Full JSON response from Collexia student registration (for debugging)',
        options: {
          language: 'json',
        },
      },
      schema: {
        is_nullable: true,
      },
    },
    {
      field: 'collexia_property_data',
      type: 'text',
      meta: {
        interface: 'input-code',
        width: 'full',
        required: false,
        readonly: true,
        note: 'Full JSON response from Collexia property registration (for debugging)',
        options: {
          language: 'json',
        },
      },
      schema: {
        is_nullable: true,
      },
    },
    {
      field: 'collexia_mandate_data',
      type: 'text',
      meta: {
        interface: 'input-code',
        width: 'full',
        required: false,
        readonly: true,
        note: 'Full JSON response from Collexia mandate registration (for debugging)',
        options: {
          language: 'json',
        },
      },
      schema: {
        is_nullable: true,
      },
    },
  ];

  try {
    // Step 1: Add fields to directus_users collection
    console.log('ðŸ“ Step 1: Adding fields to directus_users collection...\n');
    
    for (const field of userFields) {
      try {
        // Check if field already exists
        const checkResponse = await fetch(`${DIRECTUS_BASE_URL}/fields/directus_users/${field.field}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json',
          },
        });

        if (checkResponse.status === 200) {
          console.log(`   âœ… Field already exists: ${field.field}`);
          continue;
        }

        // Create the field
        const createResponse = await fetch(`${DIRECTUS_BASE_URL}/fields/directus_users`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(field),
        });

        if (createResponse.status === 200 || createResponse.status === 201) {
          console.log(`   âœ… Created field: ${field.field}`);
        } else {
          const errorText = await createResponse.text();
          if (errorText.includes('already exists') || createResponse.status === 409) {
            console.log(`   âœ… Field already exists: ${field.field}`);
          } else {
            console.log(`   âš ï¸  Failed to create ${field.field}: ${createResponse.status}`);
            console.log(`      Error: ${errorText.substring(0, 200)}`);
          }
        }
      } catch (error) {
        console.log(`   âŒ Error creating ${field.field}: ${error.message}`);
      }
    }

    // Step 2: Add fields to applications collection
    console.log('\nðŸ“ Step 2: Adding fields to applications collection...\n');
    
    for (const field of applicationFields) {
      try {
        // Check if field already exists
        const checkResponse = await fetch(`${DIRECTUS_BASE_URL}/fields/applications/${field.field}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json',
          },
        });

        if (checkResponse.status === 200) {
          console.log(`   âœ… Field already exists: ${field.field}`);
          continue;
        }

        // Create the field
        const createResponse = await fetch(`${DIRECTUS_BASE_URL}/fields/applications`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(field),
        });

        if (createResponse.status === 200 || createResponse.status === 201) {
          console.log(`   âœ… Created field: ${field.field}`);
        } else {
          const errorText = await createResponse.text();
          if (errorText.includes('already exists') || createResponse.status === 409) {
            console.log(`   âœ… Field already exists: ${field.field}`);
          } else {
            console.log(`   âš ï¸  Failed to create ${field.field}: ${createResponse.status}`);
            console.log(`      Error: ${errorText.substring(0, 200)}`);
          }
        }
      } catch (error) {
        console.log(`   âŒ Error creating ${field.field}: ${error.message}`);
      }
    }

    console.log('\n' + '='.repeat(80));
    console.log('\nâœ… Collexia fields setup complete!\n');
    console.log('ðŸ“‹ Summary:');
    console.log('   âœ… Added fields to directus_users collection:');
    userFields.forEach(f => console.log(`      - ${f.field}`));
    console.log('   âœ… Added fields to applications collection:');
    applicationFields.forEach(f => console.log(`      - ${f.field}`));
    console.log('\nðŸ“ Next steps:');
    console.log('   1. Go to Directus Admin Panel â†’ directus_users collection');
    console.log('   2. Verify the new fields are visible');
    console.log('   3. Update student profiles with bank account information');
    console.log('   4. Test application approval to trigger Collexia integration\n');

  } catch (error) {
    console.error('\nâŒ Error setting up Collexia fields:', error);
    console.log('\nðŸ“‹ Manual Setup Instructions:\n');
    console.log('1. Go to Directus Admin: https://app.pozi.com.na/admin');
    console.log('2. Settings â†’ Data Model â†’ directus_users');
    console.log('3. Add the following fields:\n');
    console.log('   Field Name        | Type      | Required | Notes');
    console.log('   ------------------|-----------|----------|-------------------');
    console.log('   account_number    | String    | No       | Bank account number');
    console.log('   bank_id           | Integer   | No       | Bank ID (64-72)');
    console.log('   account_type      | Integer   | No       | 1=Current, 2=Savings');
    console.log('   id_number         | String    | No       | Student ID number');
    console.log('   id_type           | Integer   | No       | 1=RSA ID, 2=Passport\n');
    console.log('4. Settings â†’ Data Model â†’ applications');
    console.log('5. Add field: collexia_contract_reference (String, Optional)\n');
    process.exit(1);
  }
}

// Run the setup
setupCollexiaFields().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});

